# 接口文档

所有时间均为 UTC 时间。（自行转换为本地时间）

## 详单格式

详单为大部分接口都会包含的数据，JSON 格式，包含以下字段：

```json
{
  "id": 123, // 详单 ID
  "request_amount": 100, // 请求充电量
  "already_charged": 50, // 已充电量（没有充电时为 0）
  "start_time": "2023-10-01T12:00:00Z", // 充电开始时间（没有充电时为 空）
  "last_update_time": "2023-10-01T12:15:00Z", // 最后更新时间（没有充电时为 空）
  "end_time": "2023-10-01T12:30:00Z", // 充电结束时间（没有充电时为 空）
  "charge_cost": 10.5, // 充电费用（没有充电时为 0）
  "service_fee": 2.0, // 服务费（没有充电时为 0）
  "total_cost": 12.5, // 总费用（没有充电时为 0）
  "status": "charging", // 充电状态（waiting, charging, completed, interrupted) (等待中, 充电中, 已完成, 中断)
}
```

中断状态有多种情况，为充电桩故障、用户取消充电、充电桩关闭等。

## 所有接口

### 充电桩发送

#### 充电桩注册请求

第一层封装

```json
{
    "type": "register",
    "data": "some_data" // data 格式为字符串包裹的 JSON，需要再进行一次反序列化
}
```

`data` 字段的格式为：

```json
{
    "charge_id": "id", // 充电桩生成的一个 UUID，用于标识充电桩，每次启动都不一样，当作字符串处理就行了
    "type": "F", // 充电桩类型，F 表示快充，T 表示慢充
    "power": 30.0, // 充电桩功率，单位为 kW
    "size": 2, // 队列大小
}
```

#### 充电桩状态更新

每隔一段时间充电桩会发送一次状态更新。（具体时间间隔由充电桩决定，记得收就行）（状态更新有时会作为一些服务器端操作的响应）

只有在充电桩正在充电时才会发送状态更新。

第一层封装

```json
{
    "type": "update",
    "data": "some_data" // data 格式为字符串包裹的 JSON，需要再进行一次反序列化
}
```

`data` 字段为此时在队首的详单，更新详单中的数据。

#### 充电桩充电完成

第一层封装

```json
{
    "type": "complete",
    "data": "some_data" // data 格式为字符串包裹的 JSON，需要再进行一次反序列化
}
```

`data` 字段为此时在队首的详单，更新详单中的数据。

发送后该详单出队，若队列不为空，则继续更新状态。
若队列为空，则充电桩进入空闲状态（不发送消息）。

#### 充电桩故障

第一层封装

```json
{
    "type": "fault",
    "data": "some_data" // data 格式为字符串包裹的 JSON，需要再进行一次反序列化
}
```

`data` 字段为此时在队首的详单，更新详单中的数据。

充电桩故障后 30 秒会关闭 websocket 连接。

### 充电桩接收

#### 充电桩新请求

第一层封装

```json
{
    "type": "new",
    "data": "some_data" // data 格式为字符串包裹的 JSON，需要再进行一次反序列化
}
```

`data` 字段的格式为详单，为充电桩接收到的新的充电请求。

注意：为了简化设计，默认充电桩收到新请求时队列未满，队列慢了直接忽略请求

#### 充电桩取消请求

第一层封装

```json
{
    "type": "cancel",
    "data": "some_data" // data 格式为字符串包裹的 JSON，需要再进行一次反序列化
}
```

`data` 字段的格式为详单，为充电桩接收到的取消充电请求。

收到取消请求后，充电桩会将该详单从队列中移除。

为了简化设计，默认充电桩收到取消请求时队列中有该详单，同时取消后充电桩会发送状态更新。

该状态更新会发送被取消的详单，即使该详单不在充电。

#### 充电桩关闭

第一层封装

```json
{
    "type": "close",
    "data": "some_data" // data 格式为字符串包裹的 JSON，需要再进行一次反序列化
}
```

`data` 字段为空。

收到关闭请求后，充电桩会发送状态更新。

在充电桩关闭时，会忽略除开启请求外的所有请求。

#### 充电桩开启

第一层封装

```json
{
    "type": "open",
    "data": "some_data" // data 格式为字符串包裹的 JSON，需要再进行一次反序列化
}
```

`data` 字段为空。

收到开启请求后，充电桩会开启。

此时队列为空，充电桩会等待新的充电请求。